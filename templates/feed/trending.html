{% extends 'general_base.html' %} {% load static %} {% block title %}Trending -
{% endblock %} {% block extra_css %}
<style>
  .post-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    margin-right: 12px;
    background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    flex-shrink: 0;
  }

  .post-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .post-avatar i {
    color: white;
    font-size: 24px;
  }

  .post-card {
    transition: transform 0.2s, box-shadow 0.2s;
  }
  #postsContainer .card {
    background: var(--bg-secondary);
    border-radius: 16px;
    padding: 10px;
    margin-bottom: 20px;
  }
  #postsContainer .card .card-body {
    background: var(--bg-secondary);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 20px;
    border: 1px solid white;
    color: white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .badge {
    color: white;
  }

  .post-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
  }

  .like-btn.liked {
    background-color: #dc3545;
    color: white;
    border-color: #dc3545;
  }

  .like-btn.liked i {
    animation: heartBeat 0.3s;
  }

  @keyframes heartBeat {
    0%,
    100% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.3);
    }
  }

  @keyframes pulse {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0.8;
    }
  }
</style>
{% endblock %} {% block content %}
<div class="container">
  <!-- Alert Container -->
  <div id="alertContainer" class="mt-3"></div>

  <div class="row mt-4">
    <!-- Main Content -->
    <div class="col-lg-8 mx-auto">
      <!-- Header -->
      <div
        class="card shadow-sm border-0 mb-4 bg-gradient"
        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%)"
      >
        <div class="card-body text-white p-4">
          <h2 class="mb-2"><i class="bi bi-fire"></i> Trending Now</h2>
          <p class="mb-0">Most popular posts in the last 24 hours</p>
        </div>
      </div>

      <!-- Trending Posts -->
      <div id="postsContainer">
        {% for post in posts %}
        <div
          class="card shadow-sm border-0 mb-3 post-card position-relative"
          data-post-id="{{ post.id }}"
          onclick="window.location.href='{% url 'post_detail' post.id %}'"
        >
          <div class="card-body">
            <!-- Post Header -->
            <div class="d-flex align-items-start mb-3">
              <div class="post-avatar">
                {% if post.author.profile.profile_picture and not
                post.is_anonymous %}
                <img
                  src="{{ post.author.profile.profile_picture.url }}"
                  alt="{{ post.get_author_display }}"
                />
                {% else %}
                <i class="bi bi-person-fill"></i>
                {% endif %}
              </div>
              <div class="flex-grow-1">
                <h6 class="mb-0">
                  {{ post.get_author_display }} {% if post.is_anonymous %}
                  <span class="badge bg-secondary ms-2">Anonymous</span>
                  {% endif %}
                </h6>
                <small style="font-size: 8px; color: rgb(196, 198, 200)">
                  {{ post.created_at|date:"F d, Y g:i A" }} {% if not
                  post.is_anonymous and post.author.profile.department %} • {{
                  post.author.profile.get_department_display }} • {{
                  post.author.profile.get_level_display }} {% endif %}
                </small>
              </div>
              <span class="badge bg-light text-dark"
                >{{ post.get_category_display }}</span
              >
            </div>

            <!-- Post Content -->
            <p class="card-text">{{ post.content }}</p>

            <!-- Post Image -->
            {% if post.image %}
            <img
              src="{{ post.image.url }}"
              class="img-fluid rounded mt-2"
              alt="Post image"
            />
            {% endif %}

            <!-- Engagement Stats -->
            <div class="alert alert-light mt-3 mb-0">
              <small class="text-muted">
                <i class="bi bi-fire text-danger"></i>
                <strong>{{ post.likes_count }}</strong> likes •
                <strong>{{ post.comments_count }}</strong> comments
              </small>
            </div>

            <hr />

            <!-- Post Actions -->
            <div class="d-flex justify-content-between align-items-center">
              <button
                class="btn btn-sm btn-outline-primary like-btn {% if post.id in liked_post_ids %}liked{% endif %}"
                data-post-id="{{ post.id }}"
                onclick="toggleLike({{ post.id }})"
              >
                <i
                  class="bi bi-heart{% if post.id in liked_post_ids %}-fill{% endif %}"
                ></i>
                <span class="like-count">{{ post.likes_count }}</span>
              </button>
              <button
                class="btn btn-sm btn-outline-secondary comment-btn"
                data-post-id="{{ post.id }}"
                onclick="toggleComments({{ post.id }})"
              >
                <i class="bi bi-chat"></i>
                <span class="comment-count">{{ post.comments_count }}</span>
              </button>
            </div>

            <!-- Comments Section (Hidden by default) -->
            <div
              class="comments-section mt-3"
              id="comments-{{ post.id }}"
              style="display: none"
            >
              <hr />

              <!-- Add Comment Form -->
              <div class="mb-3">
                <div class="d-flex gap-2">
                  <input
                    type="text"
                    class="form-control form-control-sm comment-input"
                    placeholder="Write a comment..."
                    id="comment-input-{{ post.id }}"
                  />
                  <button
                    class="btn btn-sm btn-primary"
                    onclick="addComment({{ post.id }})"
                  >
                    <i class="bi bi-send"></i>
                  </button>
                </div>
                <div class="form-check form-check-sm mt-2">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="anon-comment-{{ post.id }}"
                  />
                  <label
                    class="form-check-label small"
                    for="anon-comment-{{ post.id }}"
                  >
                    Comment anonymously
                  </label>
                </div>
              </div>

              <!-- Comments List -->
              <div class="comments-list" id="comments-list-{{ post.id }}">
                <div class="text-center text-muted py-2">
                  <span class="spinner-border spinner-border-sm"></span> Loading
                  comments...
                </div>
              </div>
            </div>
          </div>
        </div>
        {% empty %}
        <div class="card shadow-sm border-0">
          <div class="card-body text-center p-5">
            <i
              class="bi bi-graph-down"
              style="font-size: 3rem; color: #ccc"
            ></i>
            <h5 class="mt-3">No trending posts yet</h5>
            <p class="text-muted">
              Check back in a few hours for trending content!
            </p>
            <a href="{% url 'feed' %}" class="btn btn-primary">
              <i class="bi bi-house-door"></i> Back to Feed
            </a>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Pagination -->
      {% if posts.has_other_pages %}
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
          {% if posts.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ posts.previous_page_number }}"
              >Previous</a
            >
          </li>
          {% endif %} {% for num in posts.paginator.page_range %} {% if
          posts.number == num %}
          <li class="page-item active">
            <span class="page-link">{{ num }}</span>
          </li>
          {% else %}
          <li class="page-item">
            <a class="page-link" href="?page={{ num }}">{{ num }}</a>
          </li>
          {% endif %} {% endfor %} {% if posts.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ posts.next_page_number }}"
              >Next</a
            >
          </li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}
    </div>
  </div>
</div>

<!-- FAB -->
<div class="fab" onclick="window.location.href='{% url 'create_post_page' %}'">
  <i class="bi bi-plus-lg"></i>
</div>
{% endblock %} {% block extra_js %}
<script>
  // Reuse JavaScript from feed page
  const csrftoken = "{{ csrf_token }}";

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  async function toggleLike(postId) {
    const likeBtn = document.querySelector(
      `[data-post-id="${postId}"].like-btn`
    );
    const likeIcon = likeBtn.querySelector("i");
    const likeCount = likeBtn.querySelector(".like-count");

    try {
      const response = await fetch(`/posts/${postId}/like/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": getCookie("csrftoken"),
          "Content-Type": "application/json",
        },
      });

      const data = await response.json();

      if (data.success) {
        if (data.liked) {
          likeBtn.classList.add("liked");
          likeIcon.classList.remove("bi-heart");
          likeIcon.classList.add("bi-heart-fill");
        } else {
          likeBtn.classList.remove("liked");
          likeIcon.classList.remove("bi-heart-fill");
          likeIcon.classList.add("bi-heart");
        }
        likeCount.textContent = data.likes_count;
      }
    } catch (error) {
      console.error("Error:", error);
    }
  }

  async function toggleComments(postId) {
    const commentsSection = document.getElementById(`comments-${postId}`);
    const commentsList = document.getElementById(`comments-list-${postId}`);

    if (commentsSection.style.display === "none") {
      commentsSection.style.display = "block";
      if (!commentsList.dataset.loaded) {
        await loadComments(postId);
      }
    } else {
      commentsSection.style.display = "none";
    }
  }

  async function loadComments(postId) {
    const commentsList = document.getElementById(`comments-list-${postId}`);

    try {
      const response = await fetch(`/posts/${postId}/comments/`);
      const data = await response.json();

      if (data.success) {
        commentsList.dataset.loaded = "true";

        if (data.comments.length === 0) {
          commentsList.innerHTML =
            '<p class="text-muted text-center small py-2">No comments yet. Be the first to comment!</p>';
        } else {
          commentsList.innerHTML = data.comments
            .map((comment) => createCommentHTML(comment))
            .join("");
        }
      }
    } catch (error) {
      console.error("Error:", error);
      commentsList.innerHTML =
        '<p class="text-danger text-center small">Failed to load comments</p>';
    }
  }

  async function addComment(postId) {
    const input = document.getElementById(`comment-input-${postId}`);
    const anonCheckbox = document.getElementById(`anon-comment-${postId}`);
    const content = input.value.trim();

    if (!content) return;

    const formData = new FormData();
    formData.append("content", content);
    formData.append("is_anonymous", anonCheckbox.checked);

    try {
      const response = await fetch(`/posts/${postId}/comment/`, {
        method: "POST",
        headers: { "X-CSRFToken": getCookie("csrftoken") },
        body: formData,
      });

      const data = await response.json();

      if (data.success) {
        input.value = "";
        anonCheckbox.checked = false;

        const commentsList = document.getElementById(`comments-list-${postId}`);
        const firstComment = commentsList.querySelector("p.text-muted");

        if (
          firstComment &&
          firstComment.textContent.includes("No comments yet")
        ) {
          commentsList.innerHTML = "";
        }

        commentsList.insertAdjacentHTML(
          "beforeend",
          createCommentHTML(data.comment)
        );

        const commentCount = document.querySelector(
          `[data-post-id="${postId}"].comment-btn .comment-count`
        );
        if (commentCount) commentCount.textContent = data.comments_count;
      }
    } catch (error) {
      console.error("Error:", error);
    }
  }

  function createCommentHTML(comment) {
    const deleteBtn = comment.is_own_comment
      ? `<button class="btn btn-sm btn-link text-danger p-0 ms-2" onclick="deleteComment(${comment.id})" title="Delete">
               <i class="bi bi-trash"></i>
           </button>`
      : "";

    const authorBadge = comment.author.is_anonymous
      ? '<span class="badge bg-secondary ms-1">Anonymous</span>'
      : "";

    const departmentLevel =
      !comment.author.is_anonymous && comment.author.department
        ? `<small class="text-muted"> • ${comment.author.department} • ${comment.author.level}</small>`
        : "";

    return `
        <div class="border-start border-3 border-primary ps-3 mb-2 pb-2" id="comment-${comment.id}">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <strong class="small">${comment.author.username}</strong>${authorBadge}
                    ${departmentLevel}
                    <br>
                    <span class="small text-muted">${comment.created_at}</span>
                </div>
                ${deleteBtn}
            </div>
            <p class="mb-0 mt-1 small">${comment.content}</p>
        </div>
    `;
  }

  async function deleteComment(commentId) {
    if (!confirm("Delete this comment?")) return;

    const commentElement = document.getElementById(`comment-${commentId}`);
    const commentsList = commentElement.closest(".comments-list");
    const commentsSection = commentsList.closest(".comments-section");
    const postId = commentsSection.id.replace("comments-", "");

    try {
      const response = await fetch(`/comments/${commentId}/delete/`, {
        method: "POST",
        headers: { "X-CSRFToken": getCookie("csrftoken") },
      });

      const data = await response.json();

      if (data.success) {
        commentElement.remove();

        const commentCount = document.querySelector(
          `[data-post-id="${postId}"].comment-btn .comment-count`
        );
        if (commentCount) commentCount.textContent = data.comments_count;

        if (commentsList && commentsList.children.length === 0) {
          commentsList.innerHTML =
            '<p class="text-muted text-center small py-2">No comments yet. Be the first to comment!</p>';
        }
      }
    } catch (error) {
      console.error("Error:", error);
    }
  }
</script>
{% endblock %}
