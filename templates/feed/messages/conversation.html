{% extends 'inbox_base.html' %}
{% load feed_filters %}

{% block title %}{{ other_user.username }} / Messages{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        max-width: 600px;
        margin: 0 auto;
    }
    
    .chat-header {
        display: flex;
        align-items: center;
        padding: 8px 14px;
        border-bottom: 1px solid var(--border-color);
        background: rgba(10, 14, 39, 0.95);
        backdrop-filter: blur(20px);
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .chat-back-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: none;
        border: none;
        color: var(--text-primary);
        font-size: 20px;
        cursor: pointer;
        margin-right: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    
    .chat-back-btn:hover {
        background: var(--bg-hover);
    }
    
    .chat-user-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: var(--primary-gradient);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        overflow: hidden;
    }
    
    .chat-user-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .chat-user-avatar i {
        color: white;
        font-size: 20px;
    }
    
    .chat-user-info {
        flex: 1;
    }
    
    .chat-user-name {
        font-weight: 700;
        font-size: 16px;
    }
    
    .chat-user-status {
        font-size: 13px;
        color: var(--text-secondary);
    }
    
    /* Messages Area */
    .messages-area {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .message {
        max-width: 75%;
        display: flex;
        flex-direction: column;
    }
    
    .message.sent {
        align-self: flex-end;
    }
    
    .message.received {
        align-self: flex-start;
    }
    
    .message-bubble {
        padding: 12px 16px;
        border-radius: 20px;
        font-size: 15px;
        line-height: 1.4;
        word-wrap: break-word;
    }
    
    .message.sent .message-bubble {
        background: var(--primary-gradient);
        color: white;
        border-bottom-right-radius: 4px;
    }
    
    .message.received .message-bubble {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border-bottom-left-radius: 4px;
    }
    
    .message-time {
        font-size: 11px;
        color: var(--text-secondary);
        margin-top: 4px;
        padding: 0 8px;
    }
    
    .message.sent .message-time {
        text-align: right;
    }
    
    /* Media Messages */
    .message-media {
        border-radius: 16px;
        overflow: hidden;
        max-width: 280px;
    }
    
    .message-media img, .message-media video {
        width: 100%;
        display: block;
        cursor: pointer;
    }
    
    /* Voice Message */
    .voice-message {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        min-width: 200px;
    }
    
    .voice-play-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    .message.received .voice-play-btn {
        background: var(--bg-hover);
        color: var(--text-primary);
    }
    
    .voice-waveform {
        flex: 1;
        height: 32px;
        display: flex;
        align-items: center;
        gap: 2px;
    }
    
    .voice-bar {
        width: 3px;
        background: rgba(255,255,255,0.5);
        border-radius: 2px;
    }
    
    .message.received .voice-bar {
        background: var(--text-secondary);
    }
    
    .voice-duration {
        font-size: 12px;
        opacity: 0.8;
    }
    
    /* Shared Post */
    .shared-post {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 12px;
        margin-top: 8px;
        cursor: pointer;
    }
    
    .shared-post-label {
        font-size: 12px;
        color: var(--text-secondary);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .shared-post-content {
        font-size: 14px;
        color: var(--text-primary);
    }
    
    /* Input Area */
    .chat-input-area {
        padding: 12px 16px;
        position: relative;
        bottom: 0;
        position: fixed;
        width: 100%;
        max-width: 600px;
    }
    
    .chat-input-wrapper {
        display: flex;
        align-items: flex-end;
        gap: 8px;
        background: var(--bg-tertiary);
        border-radius: 24px;
        padding: 8px 8px 8px 16px;
    }
    
    .chat-input {
        flex: 1;
        background: none;
        border: none;
        outline: none;
        color: var(--text-primary);
        font-size: 15px;
        resize: none;
        max-height: 120px;
        line-height: 1.4;
    }
    
    .chat-input::placeholder {
        color: var(--text-secondary);
    }
    
    .chat-action-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        flex-shrink: 0;
    }
    
    .chat-action-btn:hover {
        color: var(--primary-color);
        background: var(--bg-hover);
    }
    
    .chat-send-btn {
        background: var(--primary-gradient);
        color: white;
    }
    
    .chat-send-btn:hover {
        transform: scale(1.1);
        color: white;
    }
    
    .chat-send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }
    
    /* Recording State */
    .recording-indicator {
        display: none;
        align-items: center;
        gap: 12px;
        flex: 1;
        color: #ef4444;
    }
    
    .recording-indicator.show {
        display: flex;
    }
    
    .recording-dot {
        width: 12px;
        height: 12px;
        background: #ef4444;
        border-radius: 50%;
        animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .recording-time {
        font-size: 15px;
        font-weight: 600;
    }
    
    .cancel-recording {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 8px;
    }
    
    /* Media Preview */
    .media-preview {
        display: none;
        padding: 12px;
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-tertiary);
    }
    
    .media-preview.show {
        display: block;
    }
    
    .media-preview-item {
        position: relative;
        display: inline-block;
        margin-right: 8px;
    }
    
    .media-preview-item img, .media-preview-item video {
        height: 80px;
        border-radius: 8px;
    }
    
    .media-preview-remove {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #ef4444;
        border: none;
        color: white;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* Hidden file inputs */
    .hidden-input {
        display: none;
    }
    
    /* Date separator */
    .date-separator {
        text-align: center;
        padding: 16px 0;
        color: var(--text-secondary);
        font-size: 13px;
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <!-- Header -->
    <div class="chat-header">
        <a href="{% url 'messages_inbox' %}" class="chat-back-btn">
            <i class="bi bi-arrow-left"></i>
        </a>
        <a href="{% url 'public_profile' other_user.username %}" class="chat-user-avatar">
            {% if other_user.profile.profile_picture %}
                <img src="{{ other_user.profile.profile_picture.url }}" alt="{{ other_user.username }}">
            {% else %}
                <i class="bi bi-person-fill"></i>
            {% endif %}
        </a>
        <a href="{% url 'public_profile' other_user.username %}" class="chat-user-info" style="text-decoration: none; color: inherit;">
            <div class="chat-user-name">{{ other_user.username }}</div>
            <div class="chat-user-status">@{{ other_user.username }}</div>
        </a>
    </div>
    
    <!-- Messages -->
    <div class="messages-area" id="messagesArea">
        {% for message in messages %}
            <div class="message {% if message.sender == request.user %}sent{% else %}received{% endif %}">
                {% if message.message_type == 'IMAGE' and message.image %}
                    <div class="message-media">
                        <img src="{{ message.image.url }}" alt="Image" onclick="viewImage('{{ message.image.url }}')">
                    </div>
                    {% if message.content %}
                        <div class="message-bubble" style="margin-top: 4px;">{{ message.content }}</div>
                    {% endif %}
                
                {% elif message.message_type == 'VIDEO' and message.video %}
                    <div class="message-media">
                        <video controls>
                            <source src="{{ message.video.url }}" type="video/mp4">
                        </video>
                    </div>
                    {% if message.content %}
                        <div class="message-bubble" style="margin-top: 4px;">{{ message.content }}</div>
                    {% endif %}
                
                {% elif message.message_type == 'VOICE' and message.voice_note %}
                    <div class="message-bubble voice-message" data-voice-url="{{ message.voice_note.url }}">
                        <button class="voice-play-btn" onclick="playVoice(this)">
                            <i class="bi bi-play-fill"></i>
                        </button>
                        <div class="voice-waveform">
                            {% for i in "123456789012345" %}
                                <div class="voice-bar" style="height: {% widthratio forloop.counter 15 32 %}px;"></div>
                            {% endfor %}
                        </div>
                        <span class="voice-duration">{{ message.voice_duration|default:0 }}s</span>
                    </div>
                
                {% elif message.message_type == 'POST' and message.post %}
                    {% if message.content %}
                        <div class="message-bubble">{{ message.content }}</div>
                    {% endif %}
                    <div class="shared-post" onclick="window.location.href='{% url 'post_detail' message.post.id %}'">
                        <div class="shared-post-label">
                            <i class="bi bi-share"></i> Shared post
                        </div>
                        <div class="shared-post-content">{{ message.post.content|truncatechars:100 }}</div>
                    </div>
                
                {% else %}
                    <div class="message-bubble">{{ message.content }}</div>
                {% endif %}
                
                <span class="message-time">{{ message.created_at|date:"g:i A" }}</span>
            </div>
        {% empty %}
            <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                <i class="bi bi-chat-dots" style="font-size: 48px; display: block; margin-bottom: 12px;"></i>
                <p>No messages yet. Say hello! ðŸ‘‹</p>
            </div>
        {% endfor %}
    </div>
    
    <!-- Media Preview -->
    <div class="media-preview" id="mediaPreview"></div>
    
    <!-- Input Area -->
    <div class="chat-input-area">
        <div class="chat-input-wrapper">
            <!-- Normal Input State -->
            <div id="normalInputState" style="display: flex; align-items: flex-end; gap: 8px; flex: 1;">
                <button class="chat-action-btn" onclick="document.getElementById('imageInput').click()">
                    <i class="bi bi-image"></i>
                </button>
                <textarea class="chat-input" 
                          id="messageInput" 
                          placeholder="Start a message" 
                          rows="1"
                          onkeydown="handleKeyDown(event)"></textarea>
            </div>
            
            <!-- Recording State -->
            <div class="recording-indicator" id="recordingIndicator">
                <div class="recording-dot"></div>
                <span class="recording-time" id="recordingTime">0:00</span>
                <button class="cancel-recording" onclick="cancelRecording()">
                    <i class="bi bi-x-lg"></i> Cancel
                </button>
            </div>
            
            <!-- Voice/Send Button -->
            <button class="chat-action-btn" id="voiceBtn" onclick="toggleRecording()">
                <i class="bi bi-mic"></i>
            </button>
            <button class="chat-action-btn chat-send-btn" id="sendBtn" onclick="sendMessage()" style="display: none;">
                <i class="bi bi-send-fill"></i>
            </button>
        </div>
    </div>
</div>

<!-- Hidden Inputs -->
<input type="file" id="imageInput" class="hidden-input" accept="image/*" onchange="handleMediaSelect(this, 'image')">
<input type="file" id="videoInput" class="hidden-input" accept="video/*" onchange="handleMediaSelect(this, 'video')">
{% endblock %}

{% block extra_js %}
<script>
const recipientUsername = '{{ other_user.username }}';
const messagesArea = document.getElementById('messagesArea');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const voiceBtn = document.getElementById('voiceBtn');
const mediaPreview = document.getElementById('mediaPreview');
const normalInputState = document.getElementById('normalInputState');
const recordingIndicator = document.getElementById('recordingIndicator');

let selectedMedia = null;
let mediaType = null;
let mediaRecorder = null;
let audioChunks = [];
let recordingInterval = null;
let recordingSeconds = 0;

// Scroll to bottom on load
messagesArea.scrollTop = messagesArea.scrollHeight;

// Auto-resize textarea and toggle send/voice button
messageInput.addEventListener('input', () => {
    messageInput.style.height = 'auto';
    messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
    
    toggleSendButton();
});

function toggleSendButton() {
    const hasContent = messageInput.value.trim() || selectedMedia;
    sendBtn.style.display = hasContent ? 'flex' : 'none';
    voiceBtn.style.display = hasContent ? 'none' : 'flex';
}

function handleKeyDown(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
}

// Media Selection
function handleMediaSelect(input, type) {
    const file = input.files[0];
    if (!file) return;
    
    selectedMedia = file;
    mediaType = type;
    
    const reader = new FileReader();
    reader.onload = (e) => {
        if (type === 'image') {
            mediaPreview.innerHTML = `
                <div class="media-preview-item">
                    <img src="${e.target.result}" alt="Preview">
                    <button class="media-preview-remove" onclick="clearMedia()">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            `;
        } else {
            mediaPreview.innerHTML = `
                <div class="media-preview-item">
                    <video src="${e.target.result}" style="height: 80px;"></video>
                    <button class="media-preview-remove" onclick="clearMedia()">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            `;
        }
        mediaPreview.classList.add('show');
        toggleSendButton();
    };
    reader.readAsDataURL(file);
}

function clearMedia() {
    selectedMedia = null;
    mediaType = null;
    mediaPreview.innerHTML = '';
    mediaPreview.classList.remove('show');
    document.getElementById('imageInput').value = '';
    document.getElementById('videoInput').value = '';
    toggleSendButton();
}

// Voice Recording
async function toggleRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        stopRecording();
    } else {
        startRecording();
    }
}

async function startRecording() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.ondataavailable = (e) => {
            audioChunks.push(e.data);
        };
        
        mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            sendVoiceMessage(audioBlob);
            stream.getTracks().forEach(track => track.stop());
        };
        
        mediaRecorder.start();
        recordingSeconds = 0;
        updateRecordingTime();
        recordingInterval = setInterval(updateRecordingTime, 1000);
        
        normalInputState.style.display = 'none';
        recordingIndicator.classList.add('show');
        voiceBtn.innerHTML = '<i class="bi bi-stop-fill"></i>';
        voiceBtn.style.background = '#ef4444';
        voiceBtn.style.color = 'white';
        
    } catch (err) {
        console.error('Could not start recording:', err);
        alert('Could not access microphone. Please check permissions.');
    }
}

function stopRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        clearInterval(recordingInterval);
        resetRecordingUI();
    }
}

function cancelRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        audioChunks = []; // Clear chunks so nothing gets sent
        clearInterval(recordingInterval);
        resetRecordingUI();
    }
}

function resetRecordingUI() {
    normalInputState.style.display = 'flex';
    recordingIndicator.classList.remove('show');
    voiceBtn.innerHTML = '<i class="bi bi-mic"></i>';
    voiceBtn.style.background = '';
    voiceBtn.style.color = '';
}

function updateRecordingTime() {
    recordingSeconds++;
    const mins = Math.floor(recordingSeconds / 60);
    const secs = recordingSeconds % 60;
    document.getElementById('recordingTime').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
}

// Send Messages
async function sendMessage() {
    const content = messageInput.value.trim();
    
    if (!content && !selectedMedia) return;
    
    const formData = new FormData();
    formData.append('content', content);
    
    if (selectedMedia) {
        formData.append(mediaType, selectedMedia);
    }
    
    try {
        const response = await fetch(`/messages/${recipientUsername}/send/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            appendMessage(data.message);
            messageInput.value = '';
            messageInput.style.height = 'auto';
            clearMedia();
            toggleSendButton();
        }
    } catch (error) {
        console.error('Error sending message:', error);
    }
}

async function sendVoiceMessage(audioBlob) {
    const formData = new FormData();
    formData.append('voice_note', audioBlob, 'voice.webm');
    formData.append('voice_duration', recordingSeconds);
    
    try {
        const response = await fetch(`/messages/${recipientUsername}/send/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            appendMessage(data.message);
        }
    } catch (error) {
        console.error('Error sending voice message:', error);
    }
}

function appendMessage(msg) {
    let html = `<div class="message sent">`;
    
    if (msg.image_url) {
        html += `<div class="message-media"><img src="${msg.image_url}" onclick="viewImage('${msg.image_url}')"></div>`;
    }
    
    if (msg.video_url) {
        html += `<div class="message-media"><video controls><source src="${msg.video_url}" type="video/mp4"></video></div>`;
    }
    
    if (msg.voice_url) {
        html += `
            <div class="message-bubble voice-message" data-voice-url="${msg.voice_url}">
                <button class="voice-play-btn" onclick="playVoice(this)">
                    <i class="bi bi-play-fill"></i>
                </button>
                <div class="voice-waveform">
                    ${'<div class="voice-bar" style="height: 16px;"></div>'.repeat(15)}
                </div>
                <span class="voice-duration">${msg.voice_duration || 0}s</span>
            </div>
        `;
    }
    
    if (msg.content) {
        html += `<div class="message-bubble">${msg.content}</div>`;
    }
    
    if (msg.post) {
        html += `
            <div class="shared-post" onclick="window.location.href='/post/${msg.post.id}/'">
                <div class="shared-post-label"><i class="bi bi-share"></i> Shared post</div>
                <div class="shared-post-content">${msg.post.content}</div>
            </div>
        `;
    }
    
    html += `<span class="message-time">${msg.created_at}</span></div>`;
    
    messagesArea.insertAdjacentHTML('beforeend', html);
    messagesArea.scrollTop = messagesArea.scrollHeight;
}

// Voice Playback
let currentAudio = null;

function playVoice(btn) {
    const voiceUrl = btn.closest('.voice-message').dataset.voiceUrl;
    const icon = btn.querySelector('i');
    
    if (currentAudio && !currentAudio.paused) {
        currentAudio.pause();
        currentAudio = null;
        document.querySelectorAll('.voice-play-btn i').forEach(i => {
            i.classList.remove('bi-pause-fill');
            i.classList.add('bi-play-fill');
        });
        return;
    }
    
    currentAudio = new Audio(voiceUrl);
    currentAudio.play();
    icon.classList.remove('bi-play-fill');
    icon.classList.add('bi-pause-fill');
    
    currentAudio.onended = () => {
        icon.classList.remove('bi-pause-fill');
        icon.classList.add('bi-play-fill');
    };
}

// Image viewer
function viewImage(url) {
    // Reuse your existing image modal
    const modal = document.getElementById('imageModal');
    if (modal) {
        const modalImg = document.getElementById('modalImage');
        modal.style.display = 'flex';
        modalImg.src = url;
        document.body.style.overflow = 'hidden';
    } else {
        window.open(url, '_blank');
    }
}

// CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Real-time polling for new messages
let lastMessageTimestamp = '{{ messages.last.created_at.isoformat|default:"" }}' || new Date().toISOString();
let isPolling = false;

async function pollNewMessages() {
    if (isPolling) return;
    isPolling = true;
    
    try {
        const response = await fetch(`/messages/${recipientUsername}/new/?since=${encodeURIComponent(lastMessageTimestamp)}`);
        const data = await response.json();
        
        if (data.messages && data.messages.length > 0) {
            data.messages.forEach(msg => {
                appendReceivedMessage(msg);
                lastMessageTimestamp = msg.timestamp;
            });
            
            // Scroll to bottom if already near bottom
            const isNearBottom = messagesArea.scrollHeight - messagesArea.scrollTop - messagesArea.clientHeight < 100;
            if (isNearBottom) {
                messagesArea.scrollTop = messagesArea.scrollHeight;
            }
        }
    } catch (error) {
        console.error('Error polling messages:', error);
    } finally {
        isPolling = false;
    }
}

function appendReceivedMessage(msg) {
    let html = `<div class="message received">`;
    
    if (msg.image_url) {
        html += `<div class="message-media"><img src="${msg.image_url}" alt="Image" onclick="viewImage('${msg.image_url}')"></div>`;
        if (msg.content) {
            html += `<div class="message-bubble" style="margin-top: 4px;">${escapeHtml(msg.content)}</div>`;
        }
    } else if (msg.video_url) {
        html += `<div class="message-media"><video controls><source src="${msg.video_url}" type="video/mp4"></video></div>`;
        if (msg.content) {
            html += `<div class="message-bubble" style="margin-top: 4px;">${escapeHtml(msg.content)}</div>`;
        }
    } else if (msg.voice_url) {
        html += `
            <div class="message-bubble voice-message" data-voice-url="${msg.voice_url}">
                <button class="voice-play-btn" onclick="playVoice(this)">
                    <i class="bi bi-play-fill"></i>
                </button>
                <div class="voice-waveform">
                    ${'<div class="voice-bar" style="height: 16px;"></div>'.repeat(15)}
                </div>
                <span class="voice-duration">${msg.voice_duration || 0}s</span>
            </div>
        `;
    } else if (msg.post) {
        if (msg.content) {
            html += `<div class="message-bubble">${escapeHtml(msg.content)}</div>`;
        }
        html += `
            <div class="shared-post" onclick="window.location.href='/post/${msg.post.id}/'">
                <div class="shared-post-label"><i class="bi bi-share"></i> Shared post</div>
                <div class="shared-post-content">${escapeHtml(msg.post.content)}</div>
            </div>
        `;
    } else {
        html += `<div class="message-bubble">${escapeHtml(msg.content)}</div>`;
    }
    
    html += `<span class="message-time">${msg.created_at}</span></div>`;
    
    messagesArea.insertAdjacentHTML('beforeend', html);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Start polling every 2 seconds
setInterval(pollNewMessages, 2000);

// Also poll when tab becomes visible
document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
        pollNewMessages();
    }
});
</script>
{% endblock %}